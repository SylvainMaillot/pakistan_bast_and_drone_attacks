<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pakistant Blast and Drone attacks exploration</title>
    <link rel="icon" type="image/png" href="img/bomb_red.png" />
    <!-- style -->
    <link rel="stylesheet" href="css/dashboard.css">
    <!-- firebase : those scripts MUST be imported before all the other... -->
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-database.js"></script>

    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBp7R7KCzC_pHHrWm6P0oxBNuD62sJqU3I",
        authDomain: "pakpak-8ba46.firebaseapp.com",
        databaseURL: "https://pakpak-8ba46.firebaseio.com",
        projectId: "pakpak-8ba46",
        storageBucket: "pakpak-8ba46.appspot.com",
        messagingSenderId: "559630732484"
      };
      firebase.initializeApp(config);
    </script>
    <!-- jQuery -->
    <script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
    <script src='https://code.jquery.com/ui/1.12.0/jquery-ui.min.js'></script>
    <!-- bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" media="screen" />
    <!-- toastr : for notifications managing... -->
    <link href="./css/toastr.min.css" rel="stylesheet"/>
    <script src="./js/toastr.min.js"></script>
    <!-- google maps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChtIzkJ44e3WLkQpgBOPjfp6WU-C8dNk8&libraries=drawing"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <!-- google chart -->
    <script type='text/javascript' src='https://www.gstatic.com/charts/loader.js'></script>
    <!-- query selector -->
    <link rel='stylesheet prefetch' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
    <link rel='stylesheet prefetch' href='./css/qb.css'>
    <link rel='stylesheet prefetch' href='./css/custom_qb.css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.1/css/bootstrap-datepicker3.min.css'>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/dot/1.0.3/doT.min.js'></script>
    <script src='./js/jquery_extendext.js'></script>
    <script src='./js/error_qb.js'></script>
    <script src='./js/sifter.js'></script>
    <!-- gridstack imports -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/gridstack.css"/>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.5.0/lodash.min.js"></script>
    <script src="./js/gridstack.js"></script>
    <script src="./js/gridstack.jQueryUI.js"></script>
</head>
<body>
    <!-- load the delault markers -->
    <script>
        var markers;

        function add_script(src) {
            var s = document.createElement('script');
            s.setAttribute('src', src);
            document.body.appendChild(s);
        }
        
        //load the markers if not allready present in localStorage...
        var markers = localStorage.getItem("pakpak_original_dataset");
        if (!markers || markers == "null")
            add_script("https://firebasestorage.googleapis.com/v0/b/pakpak-8ba46.appspot.com/o/default_markers.js?alt=media&token=4c77c3a5-38ee-4266-ae47-db5d32c4c471"); //download and save the dataset...
        else 
            markers = JSON.parse(markers);

        //defining a hashfunction for string...
        String.prototype.hashCode = function() {
            var hash = 0, i, chr;
            
            if (this.length === 0) return hash;
                for (i = 0; i < this.length; i++) {
                    chr   = this.charCodeAt(i);
                    hash  = ((hash << 5) - hash) + chr;
                    hash |= 0; // Convert to 32bit integer
                }

            return hash;
        };
    </script>

    <div class="container-fluid">
        <br/>
        <div class="grid-stack">
            <!-- the map -->
            <div class="grid-stack-item" data-gs-x="0" data-gs-y="0" data-gs-width="7" data-gs-height="6">
                <div class="grid-stack-item-content">
                    <div id="map" style="width:100%;height:100%"></div>
                </div>
            </div>

            <!-- filters -->
            <div class="grid-stack-item" data-gs-x="0" data-gs-y="6" data-gs-width="9" data-gs-height="3">
                <div class="grid-stack-item-content">
                    <div id="builder-basic"></div>
                </div>
            </div>

            <!-- login / create account box -->
            <div class="grid-stack-item" data-gs-x="7" data-gs-y="0" data-gs-width="2" data-gs-height="4">
                <div class="grid-stack-item-content">
                    <h3>Sign-In</h3>

                    <div id="connexion_box" style="display:block;">
                        <input id="mail_input" type="text" placeholder="email@domain.com">
                        <input id="pass_input" type="password" placeholder="password">

                        <button onclick="user_create_account();">Create Account</button>
                        <button onclick="user_sign_in();">Sign In</button>
                    </div>

                    <div id="deconnexion_box" style="display:none;">
                        <button onclick="save_and_log_out();">Save & Log Out</button></br>
                        <button onclick="user_log_out();">Just Log Out</button>
                    </div>
                </div>
            </div>

            <!-- control pannel -->
            <div class="grid-stack-item" data-gs-x="7" data-gs-y="4" data-gs-width="2" data-gs-height="2">
                <div class="grid-stack-item-content">
                    <h4>Control</h4>
                    <input type ="button" id="btn-get" value="&#9654;" title="Apply filter(s)..." style="width:100%;"></input></br>
                    <button id="stats_button" title="See some stats..." style="width:100%;">&Sigma;</button></br>
                    <button id="reset_markers_location_button" title="Refresh markers positions..." style="width:100%;">&#8634;</button></br>
                </div>
            </div>

            <!-- the list of incidents -->
            <div class="grid-stack-item" data-gs-x="9" data-gs-y="0" data-gs-width="3" data-gs-height="9">
                <div class="grid-stack-item-content">
                	<!-- <input placeholder="search" style="width:100%;height:40px;text-align:left;"></input> -->
                    <div id="overlay" class="list-group"></div>
                </div>
            </div>
            
        </div>
        <br/>
    </div>

    <div id="stats">
        <button id="close_stats">&#735;</button>
        <h1 style='text-align:center;'>some stats here...</h1>

        <!-- display the stats in 4 boxes -->
        <div id="div1">
            <div id="bubbleCity" style="width: 100%; height: 100%;"></div>
        </div>
        <div id="div2">
            <div id="week-div" style="with: 100%; height: 100%;"></div>
        </div>
        
        <div id="div3">
            
        </div>
        <div id="div4">
            timeline like</br>
            laisser l'utilisateur trouver des correlations entre 2 variables (DTW) avec comme axe commun le temps
        </div>
    </div>


    <!-- scripts -->
    <script src="js/index.js"></script>
    <script src="js/firebase_actions.js"></script>
    <script src="js/query_interpreter.js"></script>
    <script src="js/filter_gui.js"></script>
    <script>
    original_markers = markers;

    //setting toastr
    toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": false,
        "progressBar": false,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    }

    //setting gridstack
    $(function () {
        var options = {
            float: false, //set the gravity to the up
            handle: '.grid-stack-item-content',
        };
        $('.grid-stack').gridstack(options);

        //set the map not draggrable not resizable and locked, so the user can use it easilly...
        var grid = $('.grid-stack').data('gridstack');
	    $("#map").parent().parent().attr("id", "map_container");
	    grid.movable('#map_container', false);
	    grid.resizable('#map_container', false);
	    grid.locked('#map_container', true);
    });

    //refrehs the gps positions... and reset animation...
    $("#reset_markers_location_button").on('click', function () {
        for (i = 0; i < markerObjects.length; i++) {
            marker = markerObjects[i];
            marker.setPosition(new google.maps.LatLng(
                parseFloat(marker.data.Latitude)  + (Math.random() / 1000), //add very small random value to net get all points at the same place...
                parseFloat(marker.data.Longitude) + (Math.random() / 1000)
            ));
            marker.setAnimation(null);
        }
    });

    //control the stats modal window...
    $("#close_stats").on('click', function () {
        $("#stats").css("display", "none");
    });

    $("#stats_button").on('click', function() {
        refresh_graphs();
        $("#stats").css("display", "block");
    });

    //set the filter box looking good...
    $("#builder-basic").css("width", '100%');
    $(".rules-group-container").css("background", "white");
    $("body").css("overflow", "scroll");
    $("#builder-basic").css("text-align", "left");


    //the charting suffs...
    google.charts.load('current', {packages: ['corechart', 'bar']});

    function add(a, b) {
      return a + b;
    }

    function ville_list(m) {
        li =[];
        for (var i=0;i<m.length;i++){
            if (li.indexOf(m[i].City)==-1){
                li.push(m[i].City);
            }
        }
        return li;
      }

    function weekDraw() {
      var ma = get_visible_markers();
      var data = google.visualization.arrayToDataTable([
        ['Day', 'Drone Attacks', 'Blast Suicide Attacks'],
        ['Mo', ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Monday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Monday") ? 1 : 0}).reduce(add, 0)],
        ['Tu', ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Tuesday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Tuesday") ? 1 : 0}).reduce(add, 0)],
        ['We', ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Wednesday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Wednesday") ? 1 : 0}).reduce(add, 0)],
        ['Th', ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Thursday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Thursday") ? 1 : 0}).reduce(add, 0)],
        ['Fr', ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Friday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Friday") ? 1 : 0}).reduce(add, 0)],
        ['Sa',  ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Saturday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Saturday") ? 1 : 0}).reduce(add, 0)],
        ['Su',  ma.map(function(m) { return (m.type_attack == "drone" && m.day == "Sunday") ? 1 : 0}).reduce(add, 0), ma.map(function(m) { return (m.type_attack == "blast" && m.day == "Sunday") ? 1 : 0}).reduce(add, 0)],
      ]);

      var materialOptions = {
        chart: {
          title: ' Attack by day of the week'
        },
        hAxis: {
          title: 'Total Population',
          minValue: 0,
        },
        vAxis: {
          title: 'City'
        },
        bars: 'vertical',
        legend: {
            position: 'none'
        },
        height: parseInt($("#div1").css("height")) - 50,
        width: parseInt($("#div1").css("width"))
      };

      var materialChart = new google.charts.Bar(document.getElementById('week-div'));
      materialChart.draw(data, materialOptions);
    }

    function Bubble_city() {
      var ma = get_visible_markers();
      list_ville = ville_list(ma);
      data_ville = [['CITY', 'civil killed', 'civil injured','killed by terrorist','people killed by drone','terrorist killed']];
      console.log(data_ville);
      for (var i =0; i<ma.length; i++){
            if (data_ville[list_ville.indexOf(ma[i].City)+1] == undefined ) {
            data_ville[list_ville.indexOf(ma[i].City)+1] = [ma[i].City,0,0,0,0,0]; }
            if (ma[i].type_attack=="drone"){
                data_ville[list_ville.indexOf(ma[i].City)+1][4] += parseInt(ma[i].nb_killed) + parseInt(ma[i].nb_injured);}
            if (ma[i].type_attack=="blast"){
                data_ville[list_ville.indexOf(ma[i].City)+1][3] += parseInt(ma[i].nb_killed);}

            data_ville[list_ville.indexOf(ma[i].City)+1][1] += parseInt(ma[i].nb_killed) ;      
            data_ville[list_ville.indexOf(ma[i].City)+1][2] += parseInt(ma[i].nb_injured);
            data_ville[list_ville.indexOf(ma[i].City)+1][5] += parseInt(ma[i].nb_terro);
      }
      var data = google.visualization.arrayToDataTable(data_ville);

      var options = {

        title: 'Correlation of people killed by terrorist with people killed by drone' +
               ' sorted by city',
        hAxis: {title: 'civil killed or injured by drone'},
        vAxis: {title: 'civil killed or injured by terrorist'},
        bubble: {textStyle: {fontSize: 11}},
        explorer: {},
        colorAxis: {colors: ['yellow', 'red']},
        height: parseInt($("#div2").css("height")),
        width: parseInt($("#div2").css("width"))
      };

      console.log(data_ville);

      var chart = new google.visualization.BubbleChart(document.getElementById('bubbleCity'));
      chart.draw(data, options);
    }


    function refresh_graphs() {

        //google.charts.setOnLoadCallback(weekDraw);

        weekDraw();
        Bubble_city();
    } 

/////////
    
 
    
    </script>
</body>
</html>
